/**
* jsGen v0.7.3 by @zensh
* Copyright 2013 admin@zensh.com
*/
"use strict";angular.module("jsGen.locale",["ngLocale"]).run(["$locale",function(a){angular.extend(a,{RESET:{locked:"申请解锁",passwd:"找回密码",email:"请求信息已发送到您的邮箱，请查收。"},RESPONSE:{success:"请求成功",error:"请求失败"},VALIDATE:{required:"必填！",minlength:"太短！",maxlength:"太长！",min:"太小！",max:"太大！",more:"太多！",email:"Email无效！",pattern:"格式无效！",username:"有效字符为汉字、字母、数字、下划线，以汉字或小写字母开头！",minname:"长度应大于5字节，一个汉字3字节！",maxname:"长度应小于15字节，一个汉字3字节！",repasswd:"密码不一致！",url:"URL无效！",tag:"标签错误，不能包含“,”、“，”和“、”"},BTN_TEXT:{confirm:"确定",cancel:"取消",remove:"删除",goBack:"返回"},TIMING:{goHome:"秒钟后自动返回主页"},HOME:{title:"我的主页",index:" 更新，阅读时间线：",mark:"我的收藏",article:"我的文章",comment:"我的评论",follow:"我的关注",fans:"我的粉丝"},ADMIN:{index:"网站信息",user:"用户管理",tag:"标签管理",article:"文章管理",comment:"评论管理",message:"消息管理",global:"网站设置",updated:"成功更新 ",noUpdate:"设置暂无变更"},ARTICLE:{title:"添加/编辑文章",preview:"预览：",reply:"评论：",removed:"成功删除 ",updated:"成功更新 ",noUpdate:"文章暂无变更",added:"成功保存 ",markdown:"Markdown简明语法",marked:"已收藏 ",unmarked:"已取消收藏 ",favored:"已支持 ",unfavored:"已取消支持 ",opposed:"已反对 ",unopposed:"已取消反对 ",highlight:"置顶 ",unhighlight:"取消置顶 "},USER:{title:"的主页",login:"用户登录",reset:"用户信息找回",register:"用户注册",article:"的文章",fans:"的粉丝",followed:"已关注 ",unfollowed:"已取消关注 ",email:"验证邮件已发送到新邮箱，通过验证后才保存修改",updated:"用户信息更新成功",noUpdate:"用户信息暂无变更",noLogin:"您还未登录"},TAG:{title:"热门标签",removed:"成功删除 ",updated:"成功更新 ",noUpdate:"标签暂无变更"},FILTER:{role:["禁言","待验证","会员","组员","编辑","管理员"],follow:["关注","已关注"],favor:["支持","已支持"],mark:["收藏","已收藏"],oppose:["反对","已反对"],highlight:["置顶","取消置顶"],turn:["开启","关闭"],edit:["添加","编辑"],gender:{male:"男",female:"女"}},DATETIME:{second:"秒",minute:"分",hour:"时",day:"天",month:"月",year:"年",fullD:"yyyy年MM月dd日 HH:mm",shortD:"MM-dd HH:mm",dayAgo:"天前",hourAgo:"小时前",minuteAgo:"分钟前",secondAgo:"刚刚"},UPLOAD:{fileType:"文件类型无效，仅允许png、gif、jpg文件！"}})}]),angular.module("jsGen.router",["ngRoute"]).constant("app",{}).provider("getFile",["app",function(a){this.html=function(b){return"/static/tpl/"+b+"?v="+a.version},this.md=function(b){return"/static/md/"+b+"?v="+a.version},this.$get=function(){return{html:this.html,md:this.md}}}]).config(["$routeProvider","$locationProvider","getFileProvider",function(a,b,c){var d={templateUrl:c.html("index.html"),controller:"indexCtrl"},e={templateUrl:c.html("login.html"),controller:"userLoginCtrl"},f={templateUrl:c.html("register.html"),controller:"userRegisterCtrl"},g={templateUrl:c.html("user.html"),controller:"homeCtrl"},h={templateUrl:c.html("admin.html"),controller:"adminCtrl"},i={templateUrl:c.html("article-editor.html"),controller:"articleEditorCtrl"},j={templateUrl:c.html("index.html"),controller:"tagCtrl"},k={templateUrl:c.html("reset.html"),controller:"userResetCtrl"},l={templateUrl:c.html("user.html"),controller:"userCtrl"},m={templateUrl:c.html("article.html"),controller:"articleCtrl"},n={templateUrl:c.html("collection.html"),controller:"collectionCtrl"};a.when("/hots",d).when("/update",d).when("/latest",d).when("/T:ID",d).when("/tag/:TAG",d).when("/login",e).when("/register",f).when("/reset",k).when("/home",g).when("/home/:OP",g).when("/admin",h).when("/admin/:OP",h).when("/tag",j).when("/add",i).when("/A:ID/edit",i).when("/user/U:ID",l).when("/user/U:ID/:OP",l).when("/U:ID",l).when("/U:ID/:OP",l).when("/A:ID",m).when("/C:ID",n).when("/",d).otherwise({redirectTo:"/"}),b.html5Mode(!0).hashPrefix("!")}]),angular.module("jsGen.tools",[]).factory("tools",function(){function a(a){return Array.isArray?Array.isArray(a):"[object Array]"===Object.prototype.toString.call(a)}function b(a){return null===a||void 0===a||a!==a}function c(a){return b(a)?"":a+""}function d(a,b){return Object.prototype.hasOwnProperty.call(a,b)}function e(a){if(a)for(var b in a)return!d(a,b);return!0}function f(b){var c=typeof b;return null===b?"null":a(b)?"array":c}function g(a,b){return c(a).replace(b?/\s+/g:/ +/g," ").replace(/^\s+/,"").replace(/\s+$/,"")}function h(b,c,e,f,g){var h,i,j;if(c=c||angular.noop,b)if(f||a(b)){if(g){for(h=b.length-1;h>=0;h--)if(c.call(e,b[h],h,b)===n)return}else for(h=0,i=b.length;i>h;h++)if(c.call(e,b[h],h,b)===n)return}else for(j in b)if(d(b,j)&&c.call(e,b[j],j,b)===n)return}function i(a,b,c){var d=!1,e=Array.prototype.some;return b=b||angular.noop,a?e&&a.some===e?a.some(b,c):(h(a,function(a,e,f){return d=b.call(c,a,e,f),d?n:void 0}),!!d):d}function j(a,b){var c=f(a);return void 0===b&&(b=a,a="object"===c?{}:[]),c===f(b)&&("object"===c||"array"===c?h(b,function(b,c){var d=f(b);"object"===d||"array"===d?(a[c]=d===f(a[c])?a[c]:"object"===d?{}:[],j(a[c],b)):a[c]="function"===d?null:b}):a="function"===c?null:b),a}function k(a,b){var c=f(a);if(c===f(b)&&("array"===c||"object"===c))if(e(a))j(a,b);else if("array"===c&&1===a.length){var g=a[0],i=f(g);a.length=0,"function"!==i&&h(b,function(b){var c=f(b);("null"===i||i===c)&&("object"===i||"array"===i?a.push(k(j(g),b)):a.push(j(b)))})}else h(a,function(e,g){var h=f(e);"array"===c||d(b,g)?"function"===h&&"array"===c?a[g]=null:"null"===h?a[g]=j(b[g]):h===f(b[g])?"object"===h||"array"===h?k(a[g],b[g]):a[g]=b[g]:delete a[g]:delete a[g]});return a}function l(b,c){var d=0;return a(b)?h(b,function(a,e){a===c&&(b.splice(e,1),d+=1)},null,!0,!0):h(b,function(a,e){a===c&&(delete b[e],d+=1)},null,!1),d}function m(a){try{return JSON.parse(a)}catch(b){return console.error(b),null}}var n={};return{trim:g,each:h,some:i,union:j,toStr:c,isNull:b,hasOwn:d,isEmpty:e,isArray:a,intersect:k,checkType:f,remove:l,parseJSON:m}}),angular.module("jsGen.services",["ngResource","ngCookies"]).factory("restAPI",["$resource",function(a){return{index:a("/api/index/:OP"),user:a("/api/user/:ID/:OP"),article:a("/api/article/:ID/:OP"),tag:a("/api/tag/:ID/:OP")}}]).factory("cache",["$cacheFactory",function(a){return{user:a("user",{capacity:20}),article:a("article",{capacity:100}),comment:a("comment",{capacity:500}),list:a("list",{capacity:100})}}]).factory("myConf",["$cookieStore","tools",function(a,b){function c(a,c){return b.isNull(a)?c:a}function d(d,e){return function(f,g,h){g=b.toStr(g)+d,h=c(h,e);var i=c(a.get(g),h);return b.isNull(f)||i===c(f,h)||(a.put(g,f),i=f),i}}return{pageSize:d("PageSize",10),sumModel:d("sumModel",!1)}}]).factory("anchorScroll",function(){function a(a,c,d){var e=$(window).height();a=$(a),d=d>0?d:e/10,$("html, body").animate({scrollTop:c?a.offset().top-d:a.offset().top+a.outerHeight()+d-e},{duration:200,easing:"linear",complete:function(){b(a)||a[0].scrollIntoView(!!c)}})}function b(a){function b(a){return a>g&&h>a}a=$(a);var c=$(window),d=c.height(),e=a.offset().top,f=a.outerHeight(),g=c.scrollTop(),h=g+d;return b(e+(f>d?d:f)/2)?!0:f>d?b(e+f-d/2):!1}return{toView:a,inView:b}}).factory("isVisible",function(){return function(a){var b=a[0].getBoundingClientRect();return Boolean(b.bottom-b.top)}}).factory("applyFn",["$rootScope",function(a){return function(b,c){b=angular.isFunction(b)?b:angular.noop,c=c&&c.$apply?c:a,b(),c.$$phase||c.$apply()}}]).factory("timing",["$rootScope","$q","$exceptionHandler",function(a,b,c){function d(d,e,f){var g,h=0,i=b.defer(),j=i.promise;return d=angular.isFunction(d)?d:angular.noop,e=parseInt(e,10),f=parseInt(f,10),f=f>=0?f:0,g=window.setInterval(function(){if(h+=1,f&&h>=f)window.clearInterval(g),i.resolve(d(h,f,e));else try{d(h,f,e)}catch(b){i.reject(b),c(b)}a.$$phase||a.$apply()},e),j.$timingId=g,j}return d.cancel=function(a){return a&&a.$timingId?(clearInterval(a.$timingId),!0):!1},d}]).factory("promiseGet",["$q",function(a){return function(b,c,d,e){var f,g=a.defer();return f=d&&e&&e.get(d),f?g.resolve(f):c.get(b,function(a){d&&e&&e.put(d,a),g.resolve(a)},function(a){g.reject(a.error)}),g.promise}}]).factory("getList",["restAPI","cache","promiseGet",function(a,b,c){return function(d){return c({ID:d,s:10},a.article,d,b.list)}}]).factory("getArticle",["restAPI","cache","promiseGet",function(a,b,c){return function(d){return c({ID:d},a.article,d,b.article)}}]).factory("getUser",["restAPI","cache","promiseGet",function(a,b,c){return function(d){return c({ID:d},a.user,d,b.user)}}]).factory("getMarkdown",["$http",function(a){return a.get("/static/md/markdown.md",{cache:!0})}]).factory("toast",["$log","tools",function(a,b){var c={},d=["info","error","success","warning"];return angular.forEach(d,function(d){c[d]=function(c,e){var f=a[d]||a.log;e=b.toStr(e),f(c,e),c=angular.isObject(c)?angular.toJson(c):b.toStr(c),toastr[d](c,e)}}),toastr.options=angular.extend({positionClass:"toast-bottom-full-width"},c.options),c.clear=toastr.clear,c}]).factory("pretty",function(){return prettyPrint}).factory("param",function(){return $.param}).factory("CryptoJS",function(){return CryptoJS}).factory("utf8",function(){return utf8}).factory("store",function(){return store}).factory("mdParse",["tools",function(a){return function(b){return marked(a.toStr(b))}}]).factory("sanitize",["tools",function(a){var b=Sanitize,c=b.Config,d=[new b({}),new b(c.RESTRICTED),new b(c.BASIC),new b(c.RELAXED)];return function(b,c){var e=document.createElement("div"),f=document.createElement("div");return c=c>=0?c:3,e.innerHTML=a.toStr(b),f.appendChild(d[c].clean_node(e)),f.innerHTML}}]).factory("mdEditor",["mdParse","sanitize","pretty","tools",function(a,b,c,d){return function(e,f){e=d.toStr(e);var g=new Markdown.Editor({makeHtml:function(c){return b(a(c),f)}},e),h=angular.element(document.getElementById("wmd-preview"+e));return g.hooks.chain("onPreviewRefresh",function(){angular.forEach(h.find("code"),function(a){a=angular.element(a),a.parent().is("pre")||a.addClass("prettyline")}),h.find("pre").addClass("prettyprint"),c()}),g}}]),angular.module("jsGen.filters",[]).filter("placeholder",["tools",function(a){return function(b){return a.toStr(b)||"-"}}]).filter("match",["$locale",function(a){return function(b,c){return a.FILTER[c]&&a.FILTER[c][b]||""}}]).filter("switch",["$locale",function(a){return function(b,c){return a.FILTER[c]&&a.FILTER[c][+!!b]||""}}]).filter("checkName",["tools",function(a){return function(b){var c=/^[(\u4e00-\u9fa5)a-z][(\u4e00-\u9fa5)a-zA-Z0-9_]{1,}$/;return b=a.toStr(b),c.test(b)}}]).filter("length",["utf8","tools",function(a,b){return function(c){return c=b.toStr(c),a.stringToBytes(c).length}}]).filter("cutText",["utf8","tools",function(a,b){return function(c,d){c=b.trim(c);var e=a.stringToBytes(c);return d=d>0?d:0,e.length>d&&(e.length=d,c=a.bytesToString(e),c=c.slice(0,-2)+"…"),c}}]).filter("formatDate",["$filter","$locale",function(a,b){return function(c,d){var e=Date.now()-c,f=a("date");return d?f(c,b.DATETIME.fullD):e>2592e5?f(c,b.DATETIME.shortD):e>864e5?Math.floor(e/864e5)+b.DATETIME.dayAgo:e>36e5?Math.floor(e/36e5)+b.DATETIME.hourAgo:e>6e4?Math.floor(e/6e4)+b.DATETIME.minuteAgo:b.DATETIME.secondAgo}}]).filter("formatTime",["$locale",function(a){return function(b){function c(a){return e=f%a,f=(f-e)/a}var d="",e=0,f=b>0?Math.round(+b):Math.floor(Date.now()/1e3),g=a.DATETIME;return c(60),d=e+g.second,c(60),d=(e>0?e+g.minute:"")+d,c(24),d=(e>0?e+g.hour:"")+d,f>0?f+g.day+d:d}}]).filter("formatBytes",["$locale",function(){return function(a){return a=a>0?a:0,a?1024>a?a+"B":1048576>a?(a/1024).toFixed(3)+" KiB":1073741824>a?(a/1048576).toFixed(3)+" MiB":(a/1073741824).toFixed(3)+" GiB":"-"}}]),angular.module("jsGen.directives",["angularFileUpload"]).directive("genParseMd",["mdParse","sanitize","pretty","isVisible","$timeout",function(a,b,c,d,e){return function(f,g,h){function i(d){angular.isDefined(d)&&(d=a(d),d=b(d),g.html(d),angular.forEach(g.find("code"),function(a){a=angular.element(a),a.parent().is("pre")||a.addClass("prettyline")}),g.find("pre").addClass("prettyprint"),g.find("a").attr("target",function(){return this.host!==location.host?"_blank":void 0}),c())}f.$watch(h.genParseMd,function(a){d(g)?i(a):e(function(){i(a)},500)})}}]).directive("genTabClick",function(){return{link:function(a,b,c){var d=c.genTabClick;b.bind("click",function(){b.parent().children().removeClass(d),b.addClass(d)})}}}).directive("genPagination",["getFile",function(a){return{scope:!0,templateUrl:a.html("gen-pagination.html"),link:function(a,b,c){a.$watchCollection(c.genPagination,function(b){if(angular.isObject(b)){var c=1,d=[],e=Math.ceil(b.total/b.pageSize)||1;if(c=b.pageIndex>=1?b.pageIndex:1,c=e>=c?c:e,d[0]=c,6>=c)for(;d[0]>1;)d.unshift(d[0]-1);else d.unshift(d[0]-1),d.unshift(d[0]-1),d.unshift("…"),d.unshift(2),d.unshift(1);if(5>=e-c)for(;d[d.length-1]<e;)d.push(d[d.length-1]+1);else d.push(d[d.length-1]+1),d.push(d[d.length-1]+1),d.push("…"),d.push(e-1),d.push(e);a.prev=c>1?c-1:0,a.next=e>c?c+1:0,a.total=b.total,a.pageIndex=c,a.showPages=d,a.pageSize=b.pageSize,a.perPages=b.sizePerPage||[10,20,50],a.path=b.path&&b.path+"?p="}}),a.paginationTo=function(b,c){!a.path&&b>0&&(c=c||a.pageSize,a.$emit("genPagination",b,c))}}}}]).directive("genModal",["getFile","$timeout",function(a,b){var c=0;return{scope:!0,transclude:!0,templateUrl:a.html("gen-modal.html"),link:function(a,d,e){function f(a){return function(){var b=m(a)?a():!0;h(!b)}}function g(){var a=$(window),b=j.children(),c=.382*(a.height()-b.outerHeight()),d={};d.marginTop=c>0?c:0,b.css(d)}function h(a){j.modal(a?"show":"hide"),a&&b(g)}var i,j=d.children(),k=["Confirm","Cancel","Delete"],l=a.$eval(e.genModal),m=angular.isFunction;l.cancelFn=l.cancelFn||!0,l.backdrop=l.backdrop||!0,l.show=l.show||!1,l.modal=h,a.$watch(function(){return l},function(b){angular.extend(a,b)},!0),a.id=a.id||e.genModal+"-"+c++,angular.forEach(k,function(b){var c=b.toLowerCase(),d=c+"Cb",e=c+"Fn",g=c+"Btn";a[d]=l[e]&&f(l[e]),a[g]=l[g]||l[e]&&b}),j.on("shown.bs.modal",function(){i=!0}),j.on("hidden.bs.modal",function(){i&&m(l.cancelFn)&&l.cancelFn(),i=!1}),j.modal(l)}}}]).directive("genTooltip",["$timeout","isVisible",function(a,b){return{require:"?ngModel",link:function(c,d,e,f){function g(a){if(f.validate=k&&l.validate&&b(d),f.validate){var c=f.$name&&f.$name+" "||"";a&&l.validateMsg&&angular.forEach(f.$error,function(a,b){c+=a&&l.validateMsg[b]&&l.validateMsg[b]+", "||""}),c=c.slice(0,-2)||e.originalTitle||e.title,e.$set("dataOriginalTitle",c?c:""),j(!!a)}else j(!1)}function h(b){return a(function(){g(f.$invalid)}),b}function i(){d.off(".tooltip").removeData("bs.tooltip"),d.tooltip(l)}function j(a){d.hasClass("invalid-error")!==a&&(d[a?"addClass":"removeClass"]("invalid-error"),d.tooltip(a?"show":"hide"))}var k=!1,l=c.$eval(e.genTooltip)||{};"inner"===l.container?l.container=d:"ngView"===l.container&&(l.container=d.parents(".ng-view")[0]||d.parents("[ng-view]")[0]),l.validate?(l.template='<div class="tooltip validate-tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',l.trigger="manual",l.placement=l.placement||"right",f?(f.$formatters.push(h),f.$parsers.push(h)):c.$watch(function(){return e.originalTitle||e.dataOriginalTitle},j),d.bind("focus",function(){d.trigger("input"),d.trigger("change")}),c.$on("genTooltipValidate",function(a,b,c){k=!c,f&&(angular.isArray(b)&&b.push(f),g(f.$invalid))})):l.click&&d.bind("click",function(){d.tooltip(l.click)}),d.bind("hidden.bs.tooltip",i),i()}}}]).directive("genMoving",["anchorScroll",function(a){return{link:function(b,c,d){function e(){var a=c.find("textarea");a.is(a)&&a.css({height:"auto",width:"100%"})}var f=b.$eval(d.genMoving);f.appendTo=function(a){c.appendTo($(a)),e()},f.prependTo=function(a){c.prependTo($(a)),e()},f.childrenOf=function(a){return $(a).find(c).is(c)},f.scrollIntoView=function(b,d){a.toView(c,b,d)},f.inView=function(){return a.inView(c)}}}}]).directive("genSrc",["isVisible",function(a){return{priority:99,link:function(b,c,d){d.$observe("genSrc",function(b){if(b&&a(c)){var e=new Image;e.onload=function(){d.$set("src",b)},e.src=b}})}}}]).directive("genUploader",["getFile","$fileUploader","app",function(a,b,c){return{scope:!0,templateUrl:a.html("gen-uploader.html"),link:function(a,d,e){var f=a.$eval(e.genUploader);f.fileType,a.triggerUpload=function(){setTimeout(function(){d.find(".upload-input").click()})},a.clickImage=f.clickImage||angular.noop;var g=a.uploaded=[],h=a.uploader=b.create({scope:f.scope||a,url:f.url,formData:[{policy:f.policy,signature:f.signature}],filters:[function(a){var b=!0,d=a.name.split(".");return d=d.length>1?d.slice(-1)[0]:"",(!d||f.allowFileType.indexOf(d.toLowerCase())<0)&&(b=!1,c.toast.warning(c.locale.UPLOAD.fileType)),b}]});h.bind("complete",function(a,b,d){var e=c.parseJSON(b.response)||{};if(~[200,201].indexOf(b.status)){var h=c.union(d.file,e);h.url=f.baseUrl+h.url,g.push(h),d.remove()}else d.progress=0,c.toast.warning(e.message,e.code)})}}}]),angular.module("jsGen.controllers",["ui.validate"]).controller("indexCtrl",["app","$scope","$routeParams","getList",function(a,b,c,d){function e(){var d=a.location.path().slice(1).split("/");c.TAG||/^T[0-9A-Za-z]{3,}$/.test(d[0])?(h=a.restAPI.tag,b.other._id=d[0],b.other.title=c.TAG||d[0],b.parent.viewPath=""):(h=a.restAPI.article,b.parent.viewPath=d[0]||"latest"),g=c.TAG||d[0]||"latest"}function f(){var d={ID:g,p:c.p,s:c.s||i.pageSize(null,"index",20)};a.promiseGet(d,h,a.param(d),a.cache.list).then(function(c){var d=c.pagination||{};c.tag&&(b.other.title=c.tag.tag,b.other._id=c.tag._id),d.path=a.location.path(),d.pageSize=i.pageSize(d.pageSize,"index"),b.pagination=d,b.articleList=c.data})}var g="",h=a.restAPI.article,i=a.myConf,j=a.rootScope.global;j.title2=j.description,b.parent={getTpl:a.getFile.html("index-article.html"),viewPath:"latest",sumModel:i.sumModel(null,"index",!1)},b.other={},b.pagination={},b.setListModel=function(){var c=b.parent;c.sumModel=i.sumModel(!c.sumModel,"index"),i.pageSize(c.sumModel?20:10,"index"),a.location.search({})},e(),f(),d("comment").then(function(c){c=a.union(c.data),a.each(c,function(b){b.content=a.filter("cutText")(a.trim(b.content,!0),180)}),b.hotComments=c.slice(0,6)})}]).controller("tagCtrl",["app","$scope","$routeParams","getList",function(a,b,c,d){var e=a.restAPI.tag,f=a.myConf,g={p:c.p,s:c.s||f.pageSize(null,"tag",50)};a.rootScope.global.title2=a.locale.TAG.title,b.parent={getTpl:a.getFile.html("index-tag.html")},b.pagination={},a.promiseGet(g,e,a.param(g),a.cache.list).then(function(c){var d=c.pagination||{};d.path=a.location.path(),d.pageSize=f.pageSize(d.pageSize,"tag"),d.sizePerPage=[50,100,200],b.pagination=d,b.tagList=c.data}),d("comment").then(function(c){c=a.union(c.data),a.each(c,function(b){b.content=a.filter("cutText")(a.trim(b.content,!0),180)}),b.hotComments=c.slice(0,6)})}]).controller("userLoginCtrl",["app","$scope",function(a,b){a.clearUser(),a.rootScope.global.title2=a.locale.USER.login,b.login={logauto:!0,logname:"",logpwd:""},b.reset={title:"",type:""},b.submit=function(){if(a.validate(b)){var c=a.union(b.login);c.logtime=Date.now()-a.timeOffset,c.logpwd=a.CryptoJS.SHA256(c.logpwd).toString(),c.logpwd=a.CryptoJS.HmacSHA256(c.logpwd,c.logname+":"+c.logtime).toString(),a.restAPI.user.save({ID:"login"},c,function(c){a.rootScope.global.user=c.data,a.checkUser(),b.$destroy(),a.location.path("/home")},function(c){b.reset.type=c.error.name,b.reset.title=a.locale.RESET[c.error.name]})}}}]).controller("userResetCtrl",["app","$scope","$routeParams",function(a,b,c){function d(){b.timingModal.modal(!0),e=a.timing(function(a,c){b.parent.timing=c-a},1e3,b.parent.timing),e.then(function(){b.timingModal.modal(!1),a.location.search({}).path("/")})}var e,f=a.locale;a.rootScope.global.title2=f.USER.reset,b.reset={name:"",email:"",request:c.req},b.parent={title:f.RESET[c.req],timing:5},b.timingModal={confirmBtn:f.BTN_TEXT.goBack,confirmFn:function(){return a.timing.cancel(e),a.timing(null,100,1).then(function(){a.location.search({}).path("/")}),!0},cancelBtn:f.BTN_TEXT.cancel,cancelFn:function(){return a.timing.cancel(e)}},b.submit=function(){a.validate(b)&&a.restAPI.user.save({ID:"reset"},b.reset,function(){a.toast.success(f.RESET.email,f.RESPONSE.success),d()})},["locked","passwd"].indexOf(c.req)<0&&a.restAPI.user.get({ID:"reset",OP:c.req},function(){a.toast.success(3+f.TIMING.goHome,f.RESPONSE.success),a.timing(null,1e3,3).then(function(){a.location.search({}).path("/home")})},d)}]).controller("userRegisterCtrl",["app","$scope",function(a,b){var c=a.filter,d=c("length"),e=a.rootScope.global;a.clearUser(),e.title2=a.locale.USER.register,b.user={name:"",email:"",passwd:"",passwd2:""},b.checkName=function(a,b){return c("checkName")(b.$value)},b.checkMin=function(a,b){return d(b.$value)>=5},b.checkMax=function(a,b){return d(b.$value)<=15},b.submit=function(){var c=b.user;if(a.validate(b)){var d={name:c.name,email:c.email};d.passwd=a.CryptoJS.SHA256(c.passwd).toString(),a.restAPI.user.save({ID:"register"},d,function(c){a.rootScope.global.user=c.data,a.checkUser(),b.$destroy(),a.location.path("/home")})}}}]).controller("homeCtrl",["app","$scope","$routeParams",function(a,b,c){function d(a){switch(a){case"follow":case"fans":return"user-list.html";case"detail":return"user-edit.html";case"article":case"comment":case"mark":return"user-article.html";default:return"user-article.html"}}var e=a.rootScope.global;return e.isLogin?(e.title2=a.locale.HOME.title,b.user=e.user,b.parent={getTpl:a.getFile.html(d(c.OP)),isMe:!0,viewPath:c.OP||"index"},void 0):a.location.search({}).path("/")}]).controller("userCtrl",["app","$scope","$routeParams","getUser",function(a,b,c,d){function e(){switch(c.OP){case"fans":return"user-list.html";case"article":return"user-article.html";default:return"user-article.html"}}a.rootScope.global.title2=a.locale.USER.title,b.parent={getTpl:a.getFile.html(e()),isMe:!1,viewPath:c.OP||"index"},d("U"+c.ID).then(function(c){b.user=c.data,a.rootScope.global.title2=b.user.name+a.locale.USER.title})}]).controller("userListCtrl",["app","$scope","$routeParams",function(a,b,c){var d=a.restAPI.user,e=a.myConf,f=a.locale,g={ID:c.ID&&"U"+c.ID||c.OP,OP:c.OP||"fans",p:c.p,s:c.s||e.pageSize(null,"user",20)};b.parent={title:""},a.promiseGet(g,d,a.param(g),a.cache.list).then(function(d){var h=d.pagination||{};h.path=a.location.path(),h.pageSize=e.pageSize(h.pageSize,"user"),b.pagination=h,a.each(d.data,function(b){a.checkFollow(b)}),b.parent.title=c.ID?d.user.name+f.USER[g.OP]:f.HOME[g.OP],b.userList=d.data})}]).controller("userArticleCtrl",["app","$scope","$routeParams",function(a,b,c){function d(){var d={ID:c.ID&&"U"+c.ID||c.OP,OP:c.OP||(c.ID?"article":"index"),p:c.p,s:c.s||f.pageSize(null,"home",20)};a.promiseGet(d,e,a.param(d),a.cache.list).then(function(e){var i=0,j=e.pagination||{};if(j.path=a.location.path(),j.pageSize=f.pageSize(j.pageSize,"home"),b.pagination=j,c.ID)b.parent.title=e.user.name+g.USER[d.OP];else{var k=h.user||{};a.each(e.data,function(a){e.readtimestamp>0&&(a.read=a.updateTime<e.readtimestamp,i+=!a.read),a.isAuthor=a.author._id===k._id}),b.parent.title="index"!==d.OP?g.HOME[d.OP]:i+g.HOME.index+a.filter("date")(e.readtimestamp,"medium")}b.articleList=e.data})}var e=a.restAPI.user,f=a.myConf,g=a.locale,h=a.rootScope.global;b.parent={sumModel:f.sumModel(null,"index",!1),title:""},b.pagination={},b.removeArticle=null,b.removeArticleModal={confirmBtn:g.BTN_TEXT.confirm,confirmFn:function(){var c=b.removeArticle;return a.restAPI.article.remove({ID:c._id},function(){a.some(b.articleList,function(b,d,e){return b._id===c._id?(e.splice(d,1),a.toast.success(g.ARTICLE.removed+c.title,g.RESPONSE.success),!0):void 0}),b.removeArticle=null}),!0},cancelBtn:g.BTN_TEXT.cancel,cancelFn:function(){return b.removeArticle=null,!0}},b.setListModel=function(){var c=b.parent;c.sumModel=f.sumModel(!c.sumModel,"home"),f.pageSize(c.sumModel?20:10,"home"),a.location.search({})},b.remove=function(a){(a.isAuthor||h.isEditor)&&(b.removeArticle=a,b.removeArticleModal.modal(!0))},d()}]).controller("userEditCtrl",["app","$scope",function(a,b){function c(){d=a.union(g.user),a.each(d.tagsList,function(a,b,c){c[b]=a.tag}),d=a.intersect(a.union(i),d),b.user=a.union(d),a.checkDirty(i,d,b.user)}var d={},e=a.locale,f=a.filter,g=a.rootScope.global,h=f("length"),i={avatar:"",name:"",sex:"",email:"",desc:"",passwd:"",tagsList:[""]};b.sexArray=["male","female"],b.checkName=function(a,b){return f("checkName")(b.$value)},b.checkMin=function(a,b){return h(b.$value)>=5},b.checkMax=function(a,b){return h(b.$value)<=15},b.checkDesc=function(a,b){return h(b.$value)<=g.SummaryMaxLen},b.checkTag=function(a,b){var c=b.$value||"";return c=angular.isString(c)?c.split(/[,，、]/):c,c.length<=g.UserTagsMax},b.checkPwd=function(a,c){var d=c.$value||"";return d===(b.user.passwd||"")},b.getTag=function(a){var c=b.user.tagsList;c.indexOf(a.tag)<0&&c.length<g.UserTagsMax&&(b.user.tagsList=c.concat(a.tag))},b.reset=function(){b.user=a.union(d)},b.verifyEmail=function(){a.restAPI.user.save({ID:"reset"},{request:"role"},function(){a.toast.success(e.RESET.email,e.RESPONSE.success)})},b.submit=function(){var f=a.union(b.user);a.validate(b)&&(f=a.checkDirty(i,d,f),a.isEmpty(f)?a.toast.info(e.USER.noUpdate):(f.passwd&&(f.passwd=a.CryptoJS.SHA256(f.passwd).toString()),f.email&&(a.restAPI.user.save({ID:"reset"},{email:f.email,request:"email"},function(){a.toast.success(e.USER.email,e.RESPONSE.success)}),delete f.email),a.isEmpty(f)?c():a.restAPI.user.save({},f,function(b){a.union(g.user,b.data),c(),a.toast.success(e.USER.updated,e.RESPONSE.success)})))},b.$watchCollection("user",function(b){a.checkDirty(i,d,b)}),c()}]).controller("articleCtrl",["app","$scope","$routeParams","mdEditor","getList","getMarkdown",function(a,b,c,d,e,f){function g(b){var c=t._id;angular.isObject(b)&&(b.isAuthor=c===b.author._id,b.isMark=a.some(b.markList,function(a){return a._id===c}),b.isFavor=a.some(b.favorsList,function(a){return a._id===c}),b.isOppose=a.some(b.opposesList,function(a){return a._id===c}),a.each(b.commentsList,function(a){g(a)}))}function h(){return m.isLogin||a.toast.error(l.USER.noLogin),m.isLogin}function i(){var a=b.comment,c=b.article;a.replyToComment="",a.title="评论："+p(c.title,m.TitleMaxLen-9),a.content="",a.refer=c._id,b.replyMoving.prependTo("#comments")}var j="A"+c.ID,k=a.myConf,l=a.locale,m=a.rootScope.global,n=a.filter,o=n("length"),p=n("cutText"),q=a.cache.comment,r=a.cache.list,s=a.restAPI.article,t=m.user||{};t={_id:t._id,name:t.name,avatar:t.avatar},b.parent={wmdPreview:!1,contentBytes:0,markdownHelp:""},b.comment={title:"",content:"",refer:"",replyToComment:""},b.replyMoving={},b.commentMoving={},b.markdownModal={title:l.ARTICLE.markdown,cancelBtn:l.BTN_TEXT.goBack},b.validateTooltip=a.union(a.rootScope.validateTooltip),b.validateTooltip.placement="bottom",b.removeCommentModal={confirmBtn:l.BTN_TEXT.confirm,confirmFn:function(){var c=b.removeComment;return a.restAPI.article.remove({ID:c._id},function(){a.some(b.article.commentsList,function(d,e,f){return d._id===c._id?(f.splice(e,1),b.article.comments=f.length,a.toast.success(l.ARTICLE.removed+c.title,l.RESPONSE.success),!0):void 0}),b.removeComment=null}),!0},cancelBtn:l.BTN_TEXT.cancel,cancelFn:function(){return b.removeComment=null,!0}},b.remove=function(a){(a.isAuthor||m.isEditor)&&(b.removeComment=a,b.removeCommentModal.modal(!0))},b.wmdHelp=function(){f.success(function(a){b.parent.markdownHelp=a,b.markdownModal.modal(!0)})},b.wmdPreview=function(){b.parent.wmdPreview=!b.parent.wmdPreview,b.replyMoving.scrollIntoView(!0)},b.checkContentMin=function(a,c){var d=o(c.$value);return b.parent.contentBytes=d,d>=m.ContentMinLen},b.checkContentMax=function(a,b){return o(b.$value)<=m.ContentMaxLen},b.reply=function(c){var d=b.comment;d.refer=c._id,b.parent.wmdPreview=!1,c._id===b.article._id?i():(d.replyToComment=c._id,d.title=l.ARTICLE.reply+p(a.sanitize(a.mdParse(c.content),0),m.TitleMaxLen-9),b.replyMoving.appendTo("#"+c._id)),b.replyMoving.scrollIntoView()},b.getComments=function(c,d){function e(){var b=[];return a.each(c,function(a){h[a]&&b.push(h[a])}),b}var f=[],h={};if(b.referComments=[],d&&c&&c.length>0){if(b.commentMoving.childrenOf("#"+d._id))return b.commentMoving.appendTo("#comments"),void 0;b.commentMoving.appendTo("#"+d._id),a.each(c,function(a){var b=q.get(a);b?h[a]=b:f.push(a)}),b.referComments=e(),f.length>0&&s.save({ID:"comment"},{data:f},function(c){a.each(c.data,function(a){g(a),q.put(a._id,a),h[a._id]=a}),b.referComments=e()})}},b.highlight=function(a){a.status=2===a.status?1:2},b.setMark=function(b){h()&&s.save({ID:b._id,OP:"mark"},{mark:!b.isMark},function(){b.isMark=!b.isMark,b.isMark?b.markList.push(t):a.removeItem(t,"_id",b.markList),a.toast.success(l.ARTICLE[b.isMark?"marked":"unmarked"])})},b.setFavor=function(b){h()&&s.save({ID:b._id,OP:"favor"},{favor:!b.isFavor},function(){b.isFavor=!b.isFavor,b.isFavor?(b.favorsList.push(t),a.removeItem(t,"_id",b.opposesList),b.isOppose=!1):a.removeItem(t,"_id",b.favorsList),a.toast.success(l.ARTICLE[b.isFavor?"favored":"unfavored"])})},b.setOppose=function(b){h()&&s.save({ID:b._id,OP:"oppose"},{oppose:!b.isOppose},function(){b.isOppose=!b.isOppose,b.isOppose?(b.opposesList.push(t),a.removeItem(t,"_id",b.favorsList),b.isFavor=!1):a.removeItem(t,"_id",b.opposesList),a.toast.success(l.ARTICLE[b.isOppose?"opposed":"unopposed"])})},b.submit=function(){if(h()&&a.validate(b)){var c=a.union(b.comment),d=b.article;s.save({ID:d._id,OP:"comment"},c,function(c){var e=c.data,f=b.comment.replyToComment;d.commentsList.unshift(e),d.comments+=1,d.updateTime=Date.now(),f&&a.some(d.commentsList,function(a){return f===a._id?(a.commentsList.push(e._id),!0):void 0}),q.put(e._id,e),i()})}},b.$on("genPagination",function(c,d,e){c.stopPropagation();var f={ID:j,OP:"comment",p:d,s:k.pageSize(e,"comment",10)};a.promiseGet(f,s,a.param(f),r).then(function(c){var d=c.pagination||{},e=c.data;d.pageSize=k.pageSize(d.pageSize,"comment"),b.pagination=d,a.each(e,function(a){g(a),q.put(a._id,a)}),b.article.commentsList=e,a.anchorScroll.toView("#comments",!0)})}),d().run(),a.promiseGet({ID:j},s,j,a.cache.article).then(function(c){var d=c.pagination||{},e=c.data;d.pageSize=k.pageSize(d.pageSize,"comments"),g(e),a.each(e.commentsList,function(a){q.put(a._id,a)}),m.title2=e.title,b.pagination=d,b.article=e,i(),a.promiseGet({ID:e.author._id,OP:"article"},a.restAPI.user,e.author._id,r).then(function(c){var d=c.user,e=b.article.author;a.checkFollow(d),a.union(e,d),e.articlesList=c.data})}),e("hots").then(function(a){b.hotArticles=a.data.slice(0,10)})}]).controller("articleEditorCtrl",["app","$scope","$routeParams","mdEditor","getMarkdown",function(a,b,c,d,e){function f(c){s=a.union(r),c?(c=a.union(c),a.each(c.tagsList,function(a,b,c){c[b]=a.tag}),c.refer=c.refer&&c.refer.url,a.intersect(s,c),b.article=a.union(s),a.checkDirty(r,s,b.article)):(b.article={},a.each(r,function(c,d){b.article[d]=a.store.get("article."+d)||c})),g(c)}function g(a){var c=b.parent,d=b.article;a?(c.title=k.ARTICLE.preview+j(d.title),c.content=d.content):e.success(function(a){c.title=k.ARTICLE.markdown,c.content=a})}var h,i=c.ID&&"A"+c.ID,j=a.toStr,k=a.locale,l=a.rootScope.global,m=a.filter,n=a.upyun,o=m("length"),p=(m("cutText"),a.restAPI.article),q=a.cache.article,r={title:"",content:"",refer:"",tagsList:[]},s=a.union(r);if(!l.isLogin)return a.location.search({}).path("/");l.title2=a.locale.ARTICLE.title,b.parent={edit:!!i,wmdPreview:!0,contentBytes:0,titleBytes:0,title:"",content:""};var t=l.cloudDomian||l.url;b.uploaderOptions={scope:b,allowFileType:n.allowFileType,url:n.url,baseUrl:t,policy:n.policy,signature:n.signature,clickImage:function(a){b.article.content+="\n!["+a.name+"]("+a.url+")\n"}},b.validateTooltip=a.union(a.rootScope.validateTooltip),b.validateTooltip.placement="bottom",b.store=function(c){var d=b.article[c];a.store.set("article."+c,d)},b.checkTitleMin=function(c,d){var e=o(d.$value);return b.parent.titleBytes=e,b.parent.wmdPreview&&(b.parent.title=k.ARTICLE.preview+a.sanitize(a.trim(d.$value),0)),e>=l.TitleMinLen},b.checkTitleMax=function(a,b){return o(b.$value)<=l.TitleMaxLen},b.checkContentMin=function(a,c){var d=o(c.$value);return b.parent.contentBytes=d,b.parent.wmdPreview&&(b.parent.content=c.$value),d>=l.ContentMinLen},b.checkContentMax=function(a,b){return o(b.$value)<=l.ContentMaxLen},b.checkTag=function(a,b){var c=b.$value||"";return c=angular.isString(c)?c.split(/[,，、]/):c,c.length<=l.ArticleTagsMax},b.getTag=function(a){var c=b.article.tagsList;c.indexOf(a.tag)<0&&c.length<l.ArticleTagsMax&&(b.article.tagsList=c.concat(a.tag),b.store("tagsList"))
},b.wmdPreview=function(){var a=b.parent;a.wmdPreview=!a.wmdPreview,g(a.wmdPreview)},b.submit=function(){var c=a.union(b.article);a.validate(b)&&(a.checkDirty(r,s,c)?(c.title=a.sanitize(a.trim(c.title),0),p.save({ID:i||"index",OP:i&&"edit"},c,function(b){var c=b.data;h&&(delete c.commentsList,c=b.data=a.union(h.data,c)),q.put(c._id,b),f(c),a.toast.success(k.ARTICLE[i?"updated":"added"]+c.title);var d=a.timing(null,1e3,2);d.then(function(){a.location.search({}).path("/"+c._id)}),a.store.clear()})):a.toast.info(k.ARTICLE.noUpdate))},a.store.enabled||b.$watchCollection("article",function(b){a.checkDirty(r,s,b)}),d().run(),i?(h=q.get(i),a.promiseGet({ID:i},p,i,q).then(function(a){f(a.data)})):f()}]).controller("adminCtrl",["app","$scope","$routeParams",function(a,b,c){function d(a){return a="comment"===a?"article":a,"admin-"+a+".html"}var e=a.rootScope.global,f=c.OP||"index";return e.isEditor?(b.parent={getTpl:a.getFile.html(d(f)),viewPath:f},e.title2=a.locale.ADMIN[f],void 0):a.location.search({}).path("/")}]).controller("adminUserCtrl",["app","$scope","$routeParams",function(a,b,c){function d(c){e=a.intersect(a.union(j),c),b.userList=a.union(e),b.parent.editSave=!!a.checkDirty(j,e,b.userList)}var e={},f=a.restAPI.user,g=a.myConf,h=a.locale,i={ID:"admin",p:c.p,s:c.s||g.pageSize(null,"userAdmin",20)},j=[{_id:"",name:"",locked:!1,email:"",role:0,score:0,date:0,lastLoginDate:0}];b.parent={editSave:!1,isSelectAll:!1},b.pagination={},b.roleArray=[0,1,2,3,4,5],b.selectAll=function(){a.each(b.userList,function(a){a.isSelect=b.parent.isSelectAll})},b.reset=function(){b.userList=a.union(e)},b.submit=function(){var c=[{_id:"",locked:!1,role:0}];if(a.validate(b)){var g=a.checkDirty(j,e,b.userList);a.isEmpty(g)?a.toast.info(h.USER.noUpdate):(g=a.intersect(c,g),f.save({ID:"admin"},{data:g},function(c){var e=[];a.each(c.data,function(c){a.some(b.userList,function(b){return c._id===b._id?(a.union(b,c),e.push(c.name),!0):void 0})}),d(b.userList),a.toast.success(h.USER.updated+e.join(", "),h.RESPONSE.success)}))}},b.$watch("userList",function(c){b.parent.editSave=!!a.checkDirty(j,e,c)},!0),a.promiseGet(i,f).then(function(c){var e=c.pagination||{};e.path=a.location.path(),e.pageSize=g.pageSize(e.pageSize,"userAdmin"),e.sizePerPage=[20,100,200],b.pagination=e,d(c.data)})}]).controller("adminTagCtrl",["app","$scope","$routeParams",function(a,b,c){function d(c){e=a.union(a.union(j),c),b.tagList=a.union(e),b.parent.editSave=!!a.checkDirty(j,e,b.tagList)}var e={},f=a.restAPI.tag,g=a.myConf,h=a.locale,i={ID:"index",p:c.p,s:c.s||g.pageSize(null,"tagAdmin",20)},j=[{_id:"",articles:0,tag:"",users:0}];b.parent={editSave:!1},b.pagination={},b.removeTag=null,b.removeTagModal={confirmBtn:h.BTN_TEXT.confirm,confirmFn:function(){var c=b.removeTag;return f.remove({ID:c._id},function(){a.some(b.tagList,function(b,d,e){return b._id===c._id?(e.splice(d,1),a.toast.success(h.TAG.removed+c.tag,h.RESPONSE.success),!0):void 0}),d(b.tagList),b.removeTag=null}),!0},cancelBtn:h.BTN_TEXT.cancel,cancelFn:function(){return b.removeTag=null,!0}},b.checkTag=function(b,c){var d=a.toStr(c.$value);return!/[,，、]/.test(d)},b.checkTagMin=function(b,c){return a.filter("length")(c.$value)>=3},b.reset=function(){b.tagList=a.union(e)},b.remove=function(a){b.removeTag=a,b.removeTagModal.modal(!0)},b.submit=function(){var c=[{_id:"",tag:""}];if(a.validate(b)){var g=a.checkDirty(j,e,b.tagList);a.isEmpty(g)?a.toast.info(h.TAG.noUpdate):(g=a.intersect(c,g),f.save({ID:"admin"},{data:g},function(c){var e=[];a.each(g,function(d){var e=c.data[d._id];e||a.some(b.tagList,function(a,b,c){return d._id===a._id?(c.splice(b,1),!0):void 0})}),a.each(c.data,function(c){a.some(b.tagList,function(b){return c._id===b._id?(a.union(b,c),e.push(c.tag),!0):void 0})}),d(b.tagList),a.toast.success(h.TAG.updated+e.join(", "),h.RESPONSE.success)}))}},b.$watch("tagList",function(c){b.parent.editSave=!!a.checkDirty(j,e,c)},!0),a.promiseGet(i,f).then(function(c){var e=c.pagination||{};e.path=a.location.path(),e.pageSize=g.pageSize(e.pageSize,"tagAdmin"),e.sizePerPage=[20,50,100],b.pagination=e,d(c.data)})}]).controller("adminArticleCtrl",["app","$scope",function(){}]).controller("adminGlobalCtrl",["app","$scope",function(a,b){function c(c){b.global=a.union(c),e=a.union(c),e=a.intersect(a.union(d),e),b.editGlobal=a.union(e),a.checkDirty(d,e,b.editGlobal)}var d,e={},f=a.locale,g=a.filter,h=a.restAPI.index;g("length"),b.parent={switchTab:"tab1"},b.reset=function(){b.editGlobal=a.union(e)},b.submit=function(){var g=a.union(b.editGlobal);a.validate(b)&&(g=a.checkDirty(d,e,g),a.isEmpty(g)?a.toast.info(f.ADMIN.noUpdate):h.save({OP:"admin"},g,function(b){c(b.data);var d=a.union(e);delete d.smtp,delete d.email,a.union(a.rootScope.global,d),a.toast.success(f.ADMIN.updated,f.RESPONSE.success)}))},b.$watchCollection("editGlobal",function(b){a.checkDirty(d,e,b)}),a.promiseGet({OP:"admin"},h).then(function(a){d=a.configTpl,c(a.data)})}]),window.jsGen=!0,angular.module("jsGen",["ngAnimate","jsGen.tools","jsGen.router","jsGen.filters","jsGen.services","jsGen.locale","jsGen.directives","jsGen.controllers"]).config(["$httpProvider","app",function(a,b){var c=0,d=!1,e={count:0,total:0};e.cancel=function(){c=0,d=!1,this.count=0,this.total=0,b.loading(!1,this)},a.defaults.transformRequest.push(function(a){return c+=1,e.count=c,e.total+=1,d||window.setTimeout(function(){!d&&c>0&&(d=!0,b.loading(!0,e))},1e3),a}),a.defaults.transformResponse.push(function(a){return c-=1,e.count=c,d&&0===c&&e.cancel(),a}),a.interceptors.push(function(){return{response:function(a){var c,d=a.data;return angular.isObject(d)&&(b.timestamp=d.timestamp,c=!d.ack&&d.error),c?(b.toast.error(c.message,c.name),b.q.reject(d)):a},responseError:function(a){var c=a.data||a,d=a.status||"",e=c.message||(angular.isObject(c)?"Error!":c);return b.toast.error(e,d),b.q.reject(c)}}})}]).run(["app","$q","$rootScope","$location","$timeout","$filter","$locale","getFile","tools","toast","timing","cache","restAPI","sanitize","mdParse","mdEditor","CryptoJS","promiseGet","myConf","anchorScroll","isVisible","applyFn","param","store",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x){function y(){var a=B.viewWidth=C.width();B.viewHeight=C.height(),B.isPocket=480>a,B.isPhone=768>a,B.isTablet=!B.isPhone&&980>a,B.isDesktop=a>=980}function z(){m.index.get({},function(b){a.timeOffset=Date.now()-b.timestamp,b=b.data,b.title2=b.description,b.info.angularjs=angular.version.full,a.union(B,b),a.version=B.info.version||"",a.upyun=B.user&&B.user.upyun,a.checkUser()})}var A={stopUnload:!1,nextUrl:""},B=c.global={isAdmin:!1,isEditor:!1,isLogin:!1,info:{}},C=$(window);window.jsGen=a,a.q=b,a.store=x,a.toast=j,a.param=w,a.timing=k,a.location=d,a.timeout=e,a.timeOffset=0,a.timestamp=Date.now()+0,a.filter=f,a.locale=g,a.anchorScroll=t,a.isVisible=u,a.getFile=h,a.cache=l,a.restAPI=m,a.sanitize=n,a.mdParse=o,a.mdEditor=p,a.CryptoJS=q,a.promiseGet=r,a.myConf=s,a.rootScope=c,angular.extend(a,i),a.loading=function(a){c.loading.show=a,v()},a.validate=function(b,c){var d=[],e=[];return b.$broadcast("genTooltipValidate",d,c),a.each(d,function(a){a.validate&&a.$invalid&&e.push(a)}),0===e.length?(a.validate.errorList=null,b.$broadcast("genTooltipValidate",d,!0)):a.validate.errorList=e,!a.validate.errorList},a.checkDirty=function(b,c,d){var e=a.union(b);return e&&c&&d?(a.intersect(e,d),a.each(e,function(a,b,d){angular.equals(a,c[b])&&delete d[b]}),a.remove(e,void 0),A.stopUnload=!a.isEmpty(e)):A.stopUnload=!1,A.stopUnload?e:null},a.removeItem=function(b,c,d){return a.some(d,function(a,e){return a[c]===b[c]?(d.splice(e,1),!0):void 0})},a.checkUser=function(){B.isLogin=!!B.user,B.isAdmin=B.user&&5===B.user.role,B.isEditor=B.user&&B.user.role>=4},a.clearUser=function(){B.user=null,a.checkUser()},a.checkFollow=function(b){var c=B.user||{};b.isMe=b._id===c._id,b.isFollow=!b.isMe&&a.some(c.followList,function(a){return a===b._id})},c.loading={show:!1},c.validateTooltip={validate:!0,validateMsg:g.VALIDATE},c.unSaveModal={confirmBtn:g.BTN_TEXT.confirm,confirmFn:function(){return A.stopUnload&&A.nextUrl&&(A.stopUnload=!1,e(function(){window.location.href=A.nextUrl},100)),!0},cancelBtn:g.BTN_TEXT.cancel,cancelFn:!0},c.$on("$locationChangeStart",function(a,b){A.stopUnload?(a.preventDefault(),A.nextUrl=b,c.unSaveModal.modal(!0)):A.nextUrl=""}),c.goBack=function(){window.history.go(-1)},c.logout=function(){m.user.get({ID:"logout"},function(){B.user=null,a.checkUser(),d.path("/")})},c.followMe=function(b){m.user.save({ID:b._id},{follow:!b.isFollow},function(c){c.follow?(B.user.followList.push(b._id),a.toast.success(g.USER.followed+b.name,g.RESPONSE.success)):a.some(B.user.followList,function(c,d,e){return c===b._id?(e.splice(d,1),a.toast.success(g.USER.unfollowed+b.name,g.RESPONSE.success),!0):void 0}),b.fans+=b.isFollow?-1:1,b.isFollow=!b.isFollow})},C.resize(v.bind(null,y)),k(function(){Date.now()-a.timestamp-a.timeOffset>=24e4&&z()},12e4),y(),z()}]);